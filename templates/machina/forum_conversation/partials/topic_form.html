{% load i18n %}
{% load widget_tweaks %}

<form method="post" action="." class="form" enctype="multipart/form-data" novalidate>{% csrf_token %}
  {% for error in post_form.non_field_errors %}
  <div class="alert alert-danger">
    <i class="bi bi-exclamation-triangle me-1"></i> {{ error }}
  </div>
  {% endfor %}

  <!-- Subject Field -->
  <div class="mb-3">
    <label for="{{ post_form.subject.id_for_label }}" class="form-label">
      {{ post_form.subject.label }}
      {% if post_form.subject.field.required %}<span class="text-danger">*</span>{% endif %}
    </label>
    {% render_field post_form.subject class="form-control" placeholder="Enter a descriptive title for your topic" %}
    {% if post_form.subject.errors %}
      <div class="text-danger small mt-1">{{ post_form.subject.errors }}</div>
    {% endif %}
  </div>

  <!-- Content Type Selection -->
  {% if post_form.content_type %}
  <div class="mb-4">
    <label class="form-label">Content Type</label>
    <div class="form-check-container">
      {% for choice in post_form.content_type %}
        <div class="form-check">
          {{ choice.tag }}
          <label class="form-check-label" for="{{ choice.id_for_label }}">
            {{ choice.choice_label }}
          </label>
        </div>
      {% endfor %}
    </div>
    {% if post_form.content_type.errors %}
      <div class="text-danger small mt-1">{{ post_form.content_type.errors }}</div>
    {% endif %}
  </div>
  {% endif %}

  <!-- Simple Content Field -->
  <div class="mb-3" id="simple-content-section">
    <label for="{{ post_form.content.id_for_label }}" class="form-label">
      {{ post_form.content.label }}
      {% if post_form.content.field.required %}<span class="text-danger">*</span>{% endif %}
    </label>
    {% render_field post_form.content class="form-control" rows="10" placeholder="Write your post content here..." %}
    {% if post_form.content.errors %}
      <div class="text-danger small mt-1">{{ post_form.content.errors }}</div>
    {% endif %}
  </div>

  <!-- Rich Content Field -->
  {% if post_form.rich_content %}
  <div class="mb-3" id="rich-content-section" style="display: none;">
    <label class="form-label">
      Rich Content Editor
      <span class="text-muted">(Drag and drop blocks to create your post)</span>
    </label>
    
    <!-- Rich Content Editor Container -->
    <div id="rich-content-editor" class="border rounded p-3 bg-light">
      <div class="d-flex flex-wrap gap-2 mb-3" id="block-buttons">
        <button type="button" class="btn btn-sm btn-outline-primary" data-block="paragraph">
          <i class="bi bi-paragraph"></i> Paragraph
        </button>
        <button type="button" class="btn btn-sm btn-outline-primary" data-block="heading">
          <i class="bi bi-type-h1"></i> Heading
        </button>
        <button type="button" class="btn btn-sm btn-outline-primary" data-block="code">
          <i class="bi bi-code-slash"></i> Code
        </button>
        <button type="button" class="btn btn-sm btn-outline-primary" data-block="image">
          <i class="bi bi-image"></i> Image
        </button>
        <button type="button" class="btn btn-sm btn-outline-primary" data-block="video">
          <i class="bi bi-play-circle"></i> Video
        </button>
        <button type="button" class="btn btn-sm btn-outline-primary" data-block="quote">
          <i class="bi bi-quote"></i> Quote
        </button>
        <button type="button" class="btn btn-sm btn-outline-primary" data-block="callout">
          <i class="bi bi-exclamation-triangle"></i> Callout
        </button>
        <button type="button" class="btn btn-sm btn-outline-primary" data-block="list">
          <i class="bi bi-list-ul"></i> List
        </button>
        <button type="button" class="btn btn-sm btn-outline-primary" data-block="embed">
          <i class="bi bi-code-square"></i> Embed
        </button>
      </div>
      
      <div id="content-blocks" class="min-height-200">
        <div class="text-muted text-center p-4">
          <i class="bi bi-plus-circle fs-1 mb-2"></i>
          <p>Click a button above to add your first content block</p>
        </div>
      </div>
    </div>
    
    <!-- Hidden field for rich content data -->
    {% render_field post_form.rich_content %}
    
    {% if post_form.rich_content.errors %}
      <div class="text-danger small mt-1">{{ post_form.rich_content.errors }}</div>
    {% endif %}
  </div>
  {% endif %}

  <!-- Username Field (for anonymous users) -->
  {% if post_form.username %}
  <div class="mb-3">
    <label for="{{ post_form.username.id_for_label }}" class="form-label">
      {{ post_form.username.label }}
      {% if post_form.username.field.required %}<span class="text-danger">*</span>{% endif %}
    </label>
    {% render_field post_form.username class="form-control" %}
    {% if post_form.username.errors %}
      <div class="text-danger small mt-1">{{ post_form.username.errors }}</div>
    {% endif %}
  </div>
  {% endif %}

  <!-- Update Reason Field (for editing) -->
  {% if post_form.update_reason %}
  <div class="mb-3">
    <label for="{{ post_form.update_reason.id_for_label }}" class="form-label">
      {{ post_form.update_reason.label }}
    </label>
    {% render_field post_form.update_reason class="form-control" placeholder="Optional: explain what you changed" %}
    {% if post_form.update_reason.errors %}
      <div class="text-danger small mt-1">{{ post_form.update_reason.errors }}</div>
    {% endif %}
  </div>
  {% endif %}

  <!-- Additional Options Tabs -->
  {% if poll_option_formset or attachment_formset or post_form.topic_type or post_form.enable_signature %}
  <div class="card mb-3">
    <div class="card-header">
      <h5 class="mb-0">Additional Options</h5>
    </div>
    <div class="card-body">
      <!-- Tab Navigation -->
      <ul class="nav nav-tabs mb-3" id="optionsTabs" role="tablist">
        <li class="nav-item" role="presentation">
          <button class="nav-link active" id="general-tab" data-bs-toggle="tab" data-bs-target="#general" type="button" role="tab">
            <i class="bi bi-gear me-1"></i>General
          </button>
        </li>
        {% if poll_option_formset %}
        <li class="nav-item" role="presentation">
          <button class="nav-link" id="poll-tab" data-bs-toggle="tab" data-bs-target="#poll" type="button" role="tab">
            <i class="bi bi-bar-chart me-1"></i>Poll
          </button>
        </li>
        {% endif %}
        {% if attachment_formset %}
        <li class="nav-item" role="presentation">
          <button class="nav-link" id="attachments-tab" data-bs-toggle="tab" data-bs-target="#attachments" type="button" role="tab">
            <i class="bi bi-paperclip me-1"></i>Attachments
          </button>
        </li>
        {% endif %}
      </ul>
      
      <!-- Tab Content -->
      <div class="tab-content" id="optionsTabContent">
        <!-- General Options Tab -->
        <div class="tab-pane fade show active" id="general" role="tabpanel">
          {% if post_form.topic_type %}
          <div class="mb-3">
            <label for="{{ post_form.topic_type.id_for_label }}" class="form-label">
              {{ post_form.topic_type.label }}
            </label>
            {% render_field post_form.topic_type class="form-select" %}
          </div>
          {% endif %}
          
          {% if post_form.enable_signature %}
          <div class="form-check mb-3">
            {% render_field post_form.enable_signature class="form-check-input" %}
            <label class="form-check-label" for="{{ post_form.enable_signature.id_for_label }}">
              {{ post_form.enable_signature.label }}
            </label>
          </div>
          {% endif %}
          
          {% if post_form.lock_topic %}
          <div class="form-check mb-3">
            {% render_field post_form.lock_topic class="form-check-input" %}
            <label class="form-check-label" for="{{ post_form.lock_topic.id_for_label }}">
              {{ post_form.lock_topic.label }}
            </label>
          </div>
          {% endif %}
        </div>
        
        <!-- Poll Tab -->
        {% if poll_option_formset %}
        <div class="tab-pane fade" id="poll" role="tabpanel">
          {% if poll_option_formset.non_form_errors %}
            <div class="alert alert-danger">{{ poll_option_formset.non_form_errors }}</div>
          {% endif %}
          
          <div class="row">
            <div class="col-md-6">
              {% if post_form.poll_question %}
              <div class="mb-3">
                <label for="{{ post_form.poll_question.id_for_label }}" class="form-label">
                  {{ post_form.poll_question.label }}
                </label>
                {% render_field post_form.poll_question class="form-control" placeholder="Enter your poll question" %}
              </div>
              {% endif %}
              
              {% if post_form.poll_max_options %}
              <div class="mb-3">
                <label for="{{ post_form.poll_max_options.id_for_label }}" class="form-label">
                  {{ post_form.poll_max_options.label }}
                </label>
                {% render_field post_form.poll_max_options class="form-control" %}
              </div>
              {% endif %}
              
              {% if post_form.poll_duration %}
              <div class="mb-3">
                <label for="{{ post_form.poll_duration.id_for_label }}" class="form-label">
                  {{ post_form.poll_duration.label }}
                </label>
                {% render_field post_form.poll_duration class="form-control" %}
              </div>
              {% endif %}
              
              {% if post_form.poll_user_changes %}
              <div class="form-check mb-3">
                {% render_field post_form.poll_user_changes class="form-check-input" %}
                <label class="form-check-label" for="{{ post_form.poll_user_changes.id_for_label }}">
                  {{ post_form.poll_user_changes.label }}
                </label>
              </div>
              {% endif %}
              
              {% if post_form.poll_hide_results %}
              <div class="form-check mb-3">
                {% render_field post_form.poll_hide_results class="form-check-input" %}
                <label class="form-check-label" for="{{ post_form.poll_hide_results.id_for_label }}">
                  {{ post_form.poll_hide_results.label }}
                </label>
              </div>
              {% endif %}
            </div>
            
            <div id="poll_formset" class="col-md-6">
              {% include "machina/forum_conversation/forum_polls/poll_option_formset.html" %}
            </div>
          </div>
        </div>
        {% endif %}
        
        <!-- Attachments Tab -->
        {% if attachment_formset %}
        <div class="tab-pane fade" id="attachments" role="tabpanel">
          <div id="attachment_formset">
            {% include "machina/forum_conversation/forum_attachments/attachment_formset.html" %}
          </div>
        </div>
        {% endif %}
      </div>
    </div>
  </div>
  {% endif %}

  <!-- Form Actions -->
  <div class="d-flex justify-content-end gap-2">
    <input type="submit" name="preview" class="btn btn-outline-primary" value="{% trans "Preview" %}" />
    <input type="submit" class="btn btn-primary" value="{% trans "Submit" %}" />
  </div>
</form>

<!-- Rich Content Editor Styles -->
<style>
.min-height-200 { min-height: 200px; }
.content-block {
    border: 2px dashed #dee2e6;
    border-radius: 8px;
    padding: 15px;
    margin-bottom: 15px;
    background: white;
    position: relative;
}
.content-block:hover {
    border-color: #0d6efd;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}
.block-controls {
    position: absolute;
    top: -10px;
    right: 10px;
    display: none;
}
.content-block:hover .block-controls {
    display: flex;
    gap: 5px;
}
.block-type-label {
    position: absolute;
    top: -10px;
    left: 10px;
    background: #0d6efd;
    color: white;
    padding: 2px 8px;
    border-radius: 4px;
    font-size: 12px;
    font-weight: bold;
}
.form-check-container .form-check {
    display: inline-block;
    margin-right: 20px;
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Content type switching
    const contentTypeRadios = document.querySelectorAll('input[name="content_type"]');
    const simpleSection = document.getElementById('simple-content-section');
    const richSection = document.getElementById('rich-content-section');
    
    // Rich content editor state
    let contentBlocks = [];
    let blockIdCounter = 1;
    
    function updateContentTypeSections() {
        const selectedType = document.querySelector('input[name="content_type"]:checked')?.value;
        if (selectedType === 'rich') {
            simpleSection.style.display = 'none';
            richSection.style.display = 'block';
        } else {
            simpleSection.style.display = 'block';
            richSection.style.display = 'none';
        }
    }
    
    // Initialize content type sections
    updateContentTypeSections();
    
    // Listen for content type changes
    contentTypeRadios.forEach(radio => {
        radio.addEventListener('change', updateContentTypeSections);
    });
    
    // Rich content editor functionality
    const blockButtons = document.querySelectorAll('#block-buttons button[data-block]');
    const contentBlocksContainer = document.getElementById('content-blocks');
    const richContentField = document.querySelector('input[name="rich_content"]');
    
    function createBlock(blockType) {
        const blockId = `block-${blockIdCounter++}`;
        const block = {
            id: blockId,
            type: blockType,
            data: {}
        };
        
        let blockHTML = '';
        
        switch (blockType) {
            case 'paragraph':
                blockHTML = `
                    <div class="content-block" data-block-id="${blockId}">
                        <div class="block-type-label">Paragraph</div>
                        <div class="block-controls">
                            <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeBlock('${blockId}')">
                                <i class="bi bi-trash"></i>
                            </button>
                        </div>
                        <textarea class="form-control" placeholder="Enter your paragraph text..." rows="4" onchange="updateBlockData('${blockId}', 'text', this.value)"></textarea>
                    </div>
                `;
                break;
                
            case 'heading':
                blockHTML = `
                    <div class="content-block" data-block-id="${blockId}">
                        <div class="block-type-label">Heading</div>
                        <div class="block-controls">
                            <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeBlock('${blockId}')">
                                <i class="bi bi-trash"></i>
                            </button>
                        </div>
                        <input type="text" class="form-control" placeholder="Enter heading text..." onchange="updateBlockData('${blockId}', 'text', this.value)">
                    </div>
                `;
                break;
                
            case 'code':
                blockHTML = `
                    <div class="content-block" data-block-id="${blockId}">
                        <div class="block-type-label">Code</div>
                        <div class="block-controls">
                            <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeBlock('${blockId}')">
                                <i class="bi bi-trash"></i>
                            </button>
                        </div>
                        <div class="mb-2">
                            <select class="form-select form-select-sm" onchange="updateBlockData('${blockId}', 'language', this.value)">
                                <option value="python">Python</option>
                                <option value="javascript">JavaScript</option>
                                <option value="html">HTML</option>
                                <option value="css">CSS</option>
                                <option value="sql">SQL</option>
                                <option value="bash">Bash</option>
                                <option value="json">JSON</option>
                            </select>
                        </div>
                        <textarea class="form-control font-monospace" placeholder="Enter your code..." rows="5" onchange="updateBlockData('${blockId}', 'code', this.value)"></textarea>
                        <input type="text" class="form-control form-control-sm mt-2" placeholder="Optional caption..." onchange="updateBlockData('${blockId}', 'caption', this.value)">
                    </div>
                `;
                break;
                
            case 'video':
                blockHTML = `
                    <div class="content-block" data-block-id="${blockId}">
                        <div class="block-type-label">Video</div>
                        <div class="block-controls">
                            <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeBlock('${blockId}')">
                                <i class="bi bi-trash"></i>
                            </button>
                        </div>
                        <input type="url" class="form-control mb-2" placeholder="Video URL (YouTube, Vimeo, etc.)" onchange="updateBlockData('${blockId}', 'video_url', this.value)">
                        <input type="text" class="form-control mb-2" placeholder="Optional title..." onchange="updateBlockData('${blockId}', 'title', this.value)">
                        <textarea class="form-control" placeholder="Optional description..." rows="2" onchange="updateBlockData('${blockId}', 'description', this.value)"></textarea>
                    </div>
                `;
                break;
                
            case 'quote':
                blockHTML = `
                    <div class="content-block" data-block-id="${blockId}">
                        <div class="block-type-label">Quote</div>
                        <div class="block-controls">
                            <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeBlock('${blockId}')">
                                <i class="bi bi-trash"></i>
                            </button>
                        </div>
                        <textarea class="form-control mb-2" placeholder="Quote text..." rows="3" onchange="updateBlockData('${blockId}', 'text', this.value)"></textarea>
                        <input type="text" class="form-control" placeholder="Source or attribution..." onchange="updateBlockData('${blockId}', 'source', this.value)">
                    </div>
                `;
                break;
                
            case 'callout':
                blockHTML = `
                    <div class="content-block" data-block-id="${blockId}">
                        <div class="block-type-label">Callout</div>
                        <div class="block-controls">
                            <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeBlock('${blockId}')">
                                <i class="bi bi-trash"></i>
                            </button>
                        </div>
                        <div class="mb-2">
                            <select class="form-select form-select-sm" onchange="updateBlockData('${blockId}', 'type', this.value)">
                                <option value="info">Info</option>
                                <option value="warning">Warning</option>
                                <option value="success">Success</option>
                                <option value="danger">Important/Danger</option>
                                <option value="tip">Tip</option>
                                <option value="note">Note</option>
                            </select>
                        </div>
                        <input type="text" class="form-control mb-2" placeholder="Optional title..." onchange="updateBlockData('${blockId}', 'title', this.value)">
                        <textarea class="form-control" placeholder="Callout content..." rows="3" onchange="updateBlockData('${blockId}', 'text', this.value)"></textarea>
                    </div>
                `;
                break;
                
            case 'list':
                blockHTML = `
                    <div class="content-block" data-block-id="${blockId}">
                        <div class="block-type-label">List</div>
                        <div class="block-controls">
                            <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeBlock('${blockId}')">
                                <i class="bi bi-trash"></i>
                            </button>
                        </div>
                        <div class="mb-2">
                            <select class="form-select form-select-sm" onchange="updateBlockData('${blockId}', 'list_type', this.value)">
                                <option value="ul">Bulleted List</option>
                                <option value="ol">Numbered List</option>
                            </select>
                        </div>
                        <div id="${blockId}-items">
                            <input type="text" class="form-control mb-1" placeholder="List item..." onchange="updateListItems('${blockId}')">
                        </div>
                        <button type="button" class="btn btn-sm btn-outline-secondary" onclick="addListItem('${blockId}')">Add Item</button>
                    </div>
                `;
                break;
                
            case 'embed':
                blockHTML = `
                    <div class="content-block" data-block-id="${blockId}">
                        <div class="block-type-label">Embed</div>
                        <div class="block-controls">
                            <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeBlock('${blockId}')">
                                <i class="bi bi-trash"></i>
                            </button>
                        </div>
                        <textarea class="form-control mb-2" placeholder="Paste embed code (YouTube, CodePen, etc.)" rows="4" onchange="updateBlockData('${blockId}', 'embed_code', this.value)"></textarea>
                        <input type="text" class="form-control" placeholder="Optional caption..." onchange="updateBlockData('${blockId}', 'caption', this.value)">
                    </div>
                `;
                break;
        }
        
        contentBlocks.push(block);
        return blockHTML;
    }
    
    function addBlock(blockType) {
        const blockHTML = createBlock(blockType);
        
        // Remove the placeholder if it exists
        const placeholder = contentBlocksContainer.querySelector('.text-muted.text-center');
        if (placeholder) {
            placeholder.remove();
        }
        
        // Add the new block
        contentBlocksContainer.insertAdjacentHTML('beforeend', blockHTML);
        updateRichContentField();
    }
    
    window.removeBlock = function(blockId) {
        const blockElement = document.querySelector(`[data-block-id="${blockId}"]`);
        if (blockElement) {
            blockElement.remove();
        }
        
        contentBlocks = contentBlocks.filter(block => block.id !== blockId);
        
        // Show placeholder if no blocks remain
        if (contentBlocks.length === 0) {
            contentBlocksContainer.innerHTML = `
                <div class="text-muted text-center p-4">
                    <i class="bi bi-plus-circle fs-1 mb-2"></i>
                    <p>Click a button above to add your first content block</p>
                </div>
            `;
        }
        
        updateRichContentField();
    };
    
    window.updateBlockData = function(blockId, field, value) {
        const block = contentBlocks.find(b => b.id === blockId);
        if (block) {
            block.data[field] = value;
            updateRichContentField();
        }
    };
    
    window.addListItem = function(blockId) {
        const itemsContainer = document.getElementById(`${blockId}-items`);
        const newInput = document.createElement('input');
        newInput.type = 'text';
        newInput.className = 'form-control mb-1';
        newInput.placeholder = 'List item...';
        newInput.onchange = () => updateListItems(blockId);
        itemsContainer.appendChild(newInput);
    };
    
    window.updateListItems = function(blockId) {
        const itemsContainer = document.getElementById(`${blockId}-items`);
        const inputs = itemsContainer.querySelectorAll('input');
        const items = Array.from(inputs).map(input => input.value).filter(value => value.trim() !== '');
        updateBlockData(blockId, 'items', items);
    };
    
    function updateRichContentField() {
        const streamData = contentBlocks.map(block => ({
            type: block.type,
            value: block.data,
            id: block.id
        }));
        
        if (richContentField) {
            richContentField.value = JSON.stringify(streamData);
        }
    }
    
    // Add event listeners to block buttons
    blockButtons.forEach(button => {
        button.addEventListener('click', function() {
            const blockType = this.getAttribute('data-block');
            addBlock(blockType);
        });
    });
    
    // Topic type change handling (existing functionality)
    const topicTypeSelect = document.querySelector('select[name="topic_type"]');
    if (topicTypeSelect) {
        topicTypeSelect.addEventListener('change', function(e) {
            const selectedType = e.target.value;
            
            // Show/hide poll tab based on topic type
            const pollTab = document.getElementById('poll-tab');
            if (pollTab) {
                if (selectedType === 'poll') {
                    pollTab.style.display = 'block';
                    // Auto-switch to poll tab
                    const pollTabTrigger = new bootstrap.Tab(pollTab.querySelector('button'));
                    pollTabTrigger.show();
                } else {
                    // Hide poll tab if not poll type
                    const generalTab = document.getElementById('general-tab');
                    if (generalTab && pollTab.querySelector('button').classList.contains('active')) {
                        const generalTabTrigger = new bootstrap.Tab(generalTab.querySelector('button'));
                        generalTabTrigger.show();
                    }
                }
            }
        });
    }
});
</script>