{% extends "base/base.html" %}
{% load static %}

{% block title %}Code Playground - Python Learning Studio{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/code-interface.css' %}">
<!-- CodeMirror 5 CSS with advanced themes -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/theme/monokai.min.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/hint/show-hint.min.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/dialog/dialog.min.css">
<style>
/* Zebra stripes for alternate lines */
.CodeMirror-line:nth-child(even) {
    background: rgba(255, 255, 255, 0.02);
}

/* Enhanced active line */
.CodeMirror-activeline-background {
    background: rgba(255, 255, 255, 0.1) !important;
}

/* Autocomplete styling */
.CodeMirror-hints {
    background: #263238;
    border: 1px solid #455a64;
    border-radius: 4px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
}

.CodeMirror-hint {
    color: #e0e0e0;
    padding: 8px 12px;
    border-bottom: 1px solid #37474f;
}

.CodeMirror-hint:hover {
    background: #37474f;
}

.CodeMirror-hint-active {
    background: #4fc3f7 !important;
    color: #263238 !important;
}

/* Tooltip styling */
.CodeMirror-tooltip {
    background: #263238;
    border: 1px solid #455a64;
    color: #e0e0e0;
    padding: 8px 12px;
    border-radius: 4px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
    font-family: 'Cascadia Code', 'Fira Code', monospace;
    font-size: 12px;
}
</style>
{% endblock %}

{% block body_class %}playground-page{% endblock %}

{% block breadcrumb %}
<nav aria-label="breadcrumb" class="bg-dark">
    <div class="container-fluid">
        <ol class="breadcrumb mb-0 py-3">
            <li class="breadcrumb-item">
                <a href="{% url 'wagtail_serve' '' %}" class="text-light text-decoration-none">
                    <i class="bi bi-house"></i> Home
                </a>
            </li>
            <li class="breadcrumb-item">
                <a href="#" class="text-light text-decoration-none">Practice</a>
            </li>
            <li class="breadcrumb-item active text-warning" aria-current="page">Code Playground</li>
        </ol>
    </div>
</nav>
{% endblock %}

{% block content %}
<div class="container-fluid p-0">
    <div class="playground-interface">
        <div class="playground-header">
            <div class="playground-title">
                <i class="bi bi-code-square"></i> Python Code Playground
            </div>
            <div class="playground-controls">
                <select class="form-select language-selector me-2" id="languageSelector">
                    <option value="python">Python</option>
                    <option value="javascript">JavaScript</option>
                    <option value="java">Java</option>
                    <option value="cpp">C++</option>
                    <option value="html">HTML</option>
                    <option value="css">CSS</option>
                </select>
                
                <select class="form-select theme-selector me-2" id="themeSelector">
                    <option value="monokai">Material Darker</option>
                    <option value="monokai">Monokai</option>
                    <option value="dracula">Dracula</option>
                    <option value="sublime">Sublime</option>
                    <option value="solarized">Solarized Dark</option>
                </select>
                
                <button class="btn btn-outline-secondary me-2" id="formatCode">
                    <i class="bi bi-code"></i> Format
                </button>
                
                <button class="btn btn-outline-info me-2" id="snippetsBtn">
                    <i class="bi bi-collection"></i> Snippets
                </button>
                
                <button class="btn btn-outline-warning me-2" id="settingsBtn">
                    <i class="bi bi-gear"></i> Settings
                </button>
                
                <button class="btn btn-success" id="runPlaygroundCode">
                    <i class="bi bi-play-fill"></i> Run Code
                </button>
            </div>
        </div>

        <div class="playground-content">
            <div class="playground-editor">
                <div class="editor-header">
                    <div class="editor-title">
                        <i class="bi bi-file-earmark-code"></i> <span id="currentFileName">main.py</span>
                    </div>
                    <div class="editor-stats">
                        <span id="cursorPosition">Ln 1, Col 1</span>
                        <span class="mx-2">|</span>
                        <span id="selectionInfo">UTF-8</span>
                    </div>
                </div>
                <div id="playgroundEditor"></div>
            </div>
            
            <div class="playground-output">
                <div class="output-tabs">
                    <button class="output-tab active" data-tab="output" onclick="switchPlaygroundTab('output')">
                        <i class="bi bi-terminal"></i> Output
                    </button>
                    <button class="output-tab" data-tab="console" onclick="switchPlaygroundTab('console')">
                        <i class="bi bi-console"></i> Console
                    </button>
                    <button class="output-tab" data-tab="errors" onclick="switchPlaygroundTab('errors')">
                        <i class="bi bi-exclamation-triangle"></i> Errors
                    </button>
                </div>
                
                <div class="output-content">
                    <div class="output-panel active" id="outputPanel">
                        <div class="output-placeholder">
                            Write some code and click Run to see the output...
                        </div>
                    </div>
                    <div class="output-panel" id="consolePanel">
                        <div class="output-placeholder">
                            Console logs will appear here...
                        </div>
                    </div>
                    <div class="output-panel" id="errorsPanel">
                        <div class="output-placeholder">
                            Syntax errors and warnings will appear here...
                        </div>
                    </div>
                </div>
                
                <div class="output-footer">
                    <button class="btn btn-sm btn-outline-secondary" id="clearOutput">
                        <i class="bi bi-x-lg"></i> Clear
                    </button>
                    <button class="btn btn-sm btn-outline-primary" id="downloadOutput">
                        <i class="bi bi-download"></i> Download
                    </button>
                    <div class="ms-auto">
                        <small class="text-muted" id="executionTime">Ready</small>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Code Snippets Modal -->
<div class="modal fade" id="snippetsModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="bi bi-collection me-2"></i>Code Snippets Library
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-3">
                        <div class="list-group snippet-categories">
                            <button type="button" class="list-group-item list-group-item-action active" data-category="basics">
                                <i class="bi bi-play-circle me-2"></i>Basics
                            </button>
                            <button type="button" class="list-group-item list-group-item-action" data-category="data-structures">
                                <i class="bi bi-collection me-2"></i>Data Structures
                            </button>
                            <button type="button" class="list-group-item list-group-item-action" data-category="algorithms">
                                <i class="bi bi-cpu me-2"></i>Algorithms
                            </button>
                            <button type="button" class="list-group-item list-group-item-action" data-category="web">
                                <i class="bi bi-globe me-2"></i>Web Development
                            </button>
                        </div>
                    </div>
                    <div class="col-md-9">
                        <div class="snippet-content" id="snippetContent">
                            <!-- Snippets will be loaded here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Settings Modal -->
<div class="modal fade" id="settingsModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="bi bi-gear me-2"></i>Editor Settings
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label for="fontSizeRange" class="form-label">Font Size: <span id="fontSizeValue">14px</span></label>
                    <input type="range" class="form-range" id="fontSizeRange" min="10" max="24" value="14">
                </div>
                <div class="mb-3">
                    <label for="fontFamilySelect" class="form-label">Font Family</label>
                    <select class="form-select" id="fontFamilySelect">
                        <option value="Cascadia Code">Cascadia Code</option>
                        <option value="Fira Code">Fira Code</option>
                        <option value="JetBrains Mono">JetBrains Mono</option>
                        <option value="Source Code Pro">Source Code Pro</option>
                    </select>
                </div>
                <div class="form-check mb-3">
                    <input class="form-check-input" type="checkbox" id="zebraStripesCheck" checked>
                    <label class="form-check-label" for="zebraStripesCheck">
                        Zebra Stripes (Alternate Line Colors)
                    </label>
                </div>
                <div class="form-check mb-3">
                    <input class="form-check-input" type="checkbox" id="autoCompleteCheck" checked>
                    <label class="form-check-label" for="autoCompleteCheck">
                        Auto-completion
                    </label>
                </div>
                <div class="form-check mb-3">
                    <input class="form-check-input" type="checkbox" id="liveErrorCheck" checked>
                    <label class="form-check-label" for="liveErrorCheck">
                        Live Error Detection
                    </label>
                </div>
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="autoSaveCheck" checked>
                    <label class="form-check-label" for="autoSaveCheck">
                        Auto-save Code
                    </label>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="saveSettings">Save Settings</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- CodeMirror 5 with advanced features -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.js"></script>

<!-- Language modes -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/python/python.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/javascript/javascript.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/clike/clike.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/htmlmixed/htmlmixed.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/css/css.min.js"></script>

<!-- Advanced addons -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/hint/show-hint.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/hint/python-hint.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/hint/javascript-hint.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/edit/closebrackets.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/edit/matchbrackets.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/selection/active-line.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/lint/lint.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/fold/foldcode.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/fold/foldgutter.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/search/search.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/search/searchcursor.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/dialog/dialog.min.js"></script>

<!-- Additional themes -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/theme/monokai.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/theme/dracula.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/theme/sublime.min.js"></script>

<script>
// Advanced CodeMirror Playground with modern features
let playgroundEditor;
let currentLanguage = 'python';

document.addEventListener('DOMContentLoaded', function() {
    console.log('Initializing Advanced CodeMirror Playground...');
    
    if (typeof CodeMirror !== 'undefined') {
        console.log('✓ CodeMirror loaded with advanced features');
        
        // Initialize the advanced editor
        playgroundEditor = CodeMirror(document.getElementById('playgroundEditor'), {
            value: `# Welcome to Python Learning Studio Advanced Playground!
# This editor includes autocomplete, tooltips, and advanced features

def fibonacci(n):
    """Generate Fibonacci sequence up to n terms."""
    if n <= 0:
        return []
    elif n == 1:
        return [0]
    elif n == 2:
        return [0, 1]
    
    sequence = [0, 1]
    for i in range(2, n):
        sequence.append(sequence[i-1] + sequence[i-2])
    
    return sequence

# Try typing 'fib' and press Ctrl+Space for autocomplete
# Try hovering over functions for tooltips
result = fibonacci(10)
print("Fibonacci sequence:", result)

# Advanced features:
# - Ctrl+Space: Autocomplete
# - Ctrl+F: Find
# - Ctrl+H: Find & Replace
# - Tab: Indent, Shift+Tab: Unindent
# - Ctrl+/: Toggle comment
`,
            mode: 'python',
            theme: 'monokai',
            lineNumbers: true,
            indentUnit: 4,
            indentWithTabs: false,
            styleActiveLine: true,
            matchBrackets: true,
            autoCloseBrackets: true,
            foldGutter: true,
            gutters: ["CodeMirror-linenumbers", "CodeMirror-foldgutter"],
            lineWrapping: false,
            viewportMargin: Infinity,
            
            // Advanced features
            hintOptions: {
                hint: CodeMirror.hint.python,
                completeSingle: false
            },
            
            extraKeys: {
                'Ctrl-Space': 'autocomplete',
                'Tab': function(cm) {
                    if (cm.somethingSelected()) {
                        cm.indentSelection('add');
                    } else {
                        cm.replaceSelection('    ');
                    }
                },
                'Shift-Tab': function(cm) {
                    cm.indentSelection('subtract');
                },
                'Ctrl-/': function(cm) {
                    cm.toggleComment();
                },
                'Ctrl-F': 'findPersistent',
                'Ctrl-H': 'replace'
            }
        });
        
        // Set editor height
        playgroundEditor.setSize(null, '500px');
        
        // Update cursor position
        playgroundEditor.on('cursorActivity', function(cm) {
            const cursor = cm.getCursor();
            document.getElementById('cursorPosition').textContent = `Ln ${cursor.line + 1}, Col ${cursor.ch + 1}`;
        });
        
        // Auto-save functionality
        playgroundEditor.on('change', function(cm) {
            if (document.getElementById('autoSaveCheck')?.checked) {
                localStorage.setItem('playground_code', cm.getValue());
            }
        });
        
        // Setup event listeners
        setupPlaygroundEventListeners();
        
        console.log('✅ Advanced playground initialized with autocomplete, tooltips, and zebra stripes');
        
    } else {
        console.error('❌ CodeMirror not available');
    }
});

function setupPlaygroundEventListeners() {
    // Language selector
    document.getElementById('languageSelector')?.addEventListener('change', function(e) {
        changeLanguage(e.target.value);
    });
    
    // Theme selector
    document.getElementById('themeSelector')?.addEventListener('change', function(e) {
        playgroundEditor.setOption('theme', e.target.value);
    });
    
    // Run code
    document.getElementById('runPlaygroundCode')?.addEventListener('click', runPlaygroundCode);
    
    // Format code
    document.getElementById('formatCode')?.addEventListener('click', formatCode);
    
    // Clear output
    document.getElementById('clearOutput')?.addEventListener('click', function() {
        document.getElementById('outputPanel').innerHTML = '<div class="output-placeholder">Output cleared...</div>';
        document.getElementById('executionTime').textContent = 'Ready';
    });
    
    // Modal buttons
    document.getElementById('snippetsBtn')?.addEventListener('click', function() {
        new bootstrap.Modal(document.getElementById('snippetsModal')).show();
    });
    
    document.getElementById('settingsBtn')?.addEventListener('click', function() {
        new bootstrap.Modal(document.getElementById('settingsModal')).show();
    });
    
    // Settings
    document.getElementById('fontSizeRange')?.addEventListener('input', function() {
        document.getElementById('fontSizeValue').textContent = this.value + 'px';
    });
    
    document.getElementById('saveSettings')?.addEventListener('click', saveEditorSettings);
}

function changeLanguage(language) {
    currentLanguage = language;
    const modeMap = {
        'python': 'python',
        'javascript': 'javascript',
        'java': 'text/x-java',
        'cpp': 'text/x-c++src',
        'html': 'htmlmixed',
        'css': 'css'
    };
    
    const fileMap = {
        'python': 'main.py',
        'javascript': 'main.js',
        'java': 'Main.java',
        'cpp': 'main.cpp',
        'html': 'index.html',
        'css': 'styles.css'
    };
    
    playgroundEditor.setOption('mode', modeMap[language]);
    document.getElementById('currentFileName').textContent = fileMap[language];
    
    // Update hint options based on language
    if (language === 'python') {
        playgroundEditor.setOption('hintOptions', { hint: CodeMirror.hint.python });
    } else if (language === 'javascript') {
        playgroundEditor.setOption('hintOptions', { hint: CodeMirror.hint.javascript });
    }
}

async function runPlaygroundCode() {
    const code = playgroundEditor.getValue();
    const outputPanel = document.getElementById('outputPanel');
    
    if (!code.trim()) {
        showPlaygroundOutput('Please write some code first!', 'error');
        return;
    }
    
    const startTime = Date.now();
    document.getElementById('executionTime').textContent = 'Running...';
    
    // Show loading
    outputPanel.innerHTML = `
        <div class="output-loading">
            <div class="spinner-border spinner-border-sm me-2"></div>
            Executing code...
        </div>
    `;
    
    try {
        const response = await fetch('/api/v1/execute/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCSRFToken()
            },
            body: JSON.stringify({ code, language: currentLanguage })
        });
        
        const result = await response.json();
        const executionTime = Date.now() - startTime;
        
        if (result.success) {
            showPlaygroundOutput(result.output, 'success');
        } else {
            showPlaygroundOutput(result.error, 'error');
        }
        
        document.getElementById('executionTime').textContent = `Executed in ${executionTime}ms`;
        
    } catch (error) {
        showPlaygroundOutput(`Error: ${error.message}`, 'error');
        document.getElementById('executionTime').textContent = 'Error';
    }
}

function showPlaygroundOutput(content, type = 'info') {
    const timestamp = new Date().toLocaleTimeString();
    const icon = type === 'success' ? 'check-circle' : type === 'error' ? 'x-circle' : 'info-circle';
    const className = type === 'success' ? 'text-success' : type === 'error' ? 'text-danger' : 'text-info';
    
    document.getElementById('outputPanel').innerHTML = `
        <div class="output-result">
            <div class="output-header">
                <i class="bi bi-${icon} ${className}"></i>
                <span class="output-timestamp">${timestamp}</span>
            </div>
            <pre class="output-content">${content}</pre>
        </div>
    `;
}

function switchPlaygroundTab(tabName) {
    document.querySelectorAll('.output-tab').forEach(tab => tab.classList.remove('active'));
    document.querySelectorAll('.output-panel').forEach(panel => panel.classList.remove('active'));
    
    document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');
    document.getElementById(tabName + 'Panel').classList.add('active');
}

function formatCode() {
    // Basic code formatting (this could be enhanced with a proper formatter)
    const code = playgroundEditor.getValue();
    // For now, just auto-indent
    playgroundEditor.execCommand('selectAll');
    playgroundEditor.execCommand('indentAuto');
    playgroundEditor.execCommand('goDocEnd');
}

function saveEditorSettings() {
    const settings = {
        fontSize: document.getElementById('fontSizeRange').value,
        fontFamily: document.getElementById('fontFamilySelect').value,
        zebraStripes: document.getElementById('zebraStripesCheck').checked,
        autoComplete: document.getElementById('autoCompleteCheck').checked,
        autoSave: document.getElementById('autoSaveCheck').checked
    };
    
    localStorage.setItem('playgroundSettings', JSON.stringify(settings));
    applyEditorSettings(settings);
    
    bootstrap.Modal.getInstance(document.getElementById('settingsModal')).hide();
}

function applyEditorSettings(settings) {
    // Apply font settings
    const editorElement = document.querySelector('.CodeMirror');
    if (editorElement) {
        editorElement.style.fontSize = settings.fontSize + 'px';
        editorElement.style.fontFamily = settings.fontFamily;
    }
    
    // Toggle zebra stripes
    if (settings.zebraStripes) {
        document.querySelector('.CodeMirror').classList.add('zebra-stripes');
    } else {
        document.querySelector('.CodeMirror').classList.remove('zebra-stripes');
    }
}

function getCSRFToken() {
    const token = document.querySelector('[name=csrfmiddlewaretoken]');
    return token ? token.value : '';
}

// Load saved settings on page load
window.addEventListener('load', function() {
    const savedSettings = localStorage.getItem('playgroundSettings');
    if (savedSettings) {
        const settings = JSON.parse(savedSettings);
        applyEditorSettings(settings);
        
        // Update form elements
        if (document.getElementById('fontSizeRange')) {
            document.getElementById('fontSizeRange').value = settings.fontSize || 14;
            document.getElementById('fontSizeValue').textContent = (settings.fontSize || 14) + 'px';
        }
    }
    
    // Load auto-saved code
    const savedCode = localStorage.getItem('playground_code');
    if (savedCode && playgroundEditor) {
        playgroundEditor.setValue(savedCode);
    }
});
</script>
{% endblock %}