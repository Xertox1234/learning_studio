{% extends 'base/base.html' %}
{% load static %}

{% block title %}Moderation Dashboard - Python Learning Studio{% endblock %}

{% block extra_css %}
<style>
.moderation-stats {
    background: var(--bs-light);
    border-radius: 8px;
    padding: 15px;
    margin-bottom: 20px;
}

.stat-card {
    text-align: center;
    padding: 10px;
}

.stat-number {
    font-size: 2rem;
    font-weight: bold;
    color: var(--bs-primary);
}

.review-item {
    border: 1px solid var(--bs-border-color);
    border-radius: 6px;
    padding: 15px;
    margin-bottom: 10px;
    background: var(--bs-white);
}

.review-item.priority-1 {
    border-left: 4px solid #dc3545;
}

.review-item.priority-2 {
    border-left: 4px solid #fd7e14;
}

.review-item.priority-3 {
    border-left: 4px solid #ffc107;
}

.review-item.priority-4 {
    border-left: 4px solid #6c757d;
}

.priority-badge {
    font-size: 0.75rem;
    padding: 2px 6px;
}

.bulk-actions {
    position: sticky;
    top: 10px;
    background: var(--bs-white);
    border: 1px solid var(--bs-border-color);
    border-radius: 6px;
    padding: 10px;
    margin-bottom: 15px;
    display: none;
}

.bulk-actions.show {
    display: block;
}

.content-preview {
    font-style: italic;
    color: var(--bs-secondary);
    max-height: 60px;
    overflow: hidden;
}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <h1><i class="bi bi-shield-check"></i> Moderation Dashboard</h1>
            
            <!-- Statistics -->
            <div class="moderation-stats">
                <div class="row">
                    <div class="col-md-3">
                        <div class="stat-card">
                            <div class="stat-number">{{ stats.total_pending }}</div>
                            <div class="text-muted">Pending Reviews</div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="stat-card">
                            <div class="stat-number">{{ stats.assigned_to_me }}</div>
                            <div class="text-muted">Assigned to Me</div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="stat-card">
                            <div class="stat-number text-danger">{{ stats.critical_items }}</div>
                            <div class="text-muted">Critical Items</div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="stat-card">
                            <div class="stat-number">{{ stats.avg_resolution_time|floatformat:1 }}h</div>
                            <div class="text-muted">Avg Resolution Time</div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Filters -->
            <div class="card mb-3">
                <div class="card-body">
                    <form method="get" class="row g-3">
                        <div class="col-md-2">
                            <label for="status" class="form-label">Status</label>
                            <select name="status" id="status" class="form-select">
                                <option value="all" {% if status_filter == 'all' %}selected{% endif %}>All</option>
                                <option value="pending" {% if status_filter == 'pending' %}selected{% endif %}>Pending</option>
                                <option value="approved" {% if status_filter == 'approved' %}selected{% endif %}>Approved</option>
                                <option value="rejected" {% if status_filter == 'rejected' %}selected{% endif %}>Rejected</option>
                                <option value="escalated" {% if status_filter == 'escalated' %}selected{% endif %}>Escalated</option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <label for="type" class="form-label">Type</label>
                            <select name="type" id="type" class="form-select">
                                <option value="all" {% if type_filter == 'all' %}selected{% endif %}>All Types</option>
                                {% for value, label in review_type_choices %}
                                <option value="{{ value }}" {% if type_filter == value %}selected{% endif %}>{{ label }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-2">
                            <label for="assigned" class="form-label">Assigned</label>
                            <select name="assigned" id="assigned" class="form-select">
                                <option value="all" {% if assigned_filter == 'all' %}selected{% endif %}>All</option>
                                <option value="mine" {% if assigned_filter == 'mine' %}selected{% endif %}>Mine</option>
                                <option value="unassigned" {% if assigned_filter == 'unassigned' %}selected{% endif %}>Unassigned</option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <label for="priority" class="form-label">Priority</label>
                            <select name="priority" id="priority" class="form-select">
                                <option value="all" {% if priority_filter == 'all' %}selected{% endif %}>All</option>
                                {% for value, label in priority_choices %}
                                <option value="{{ value }}" {% if priority_filter == value %}selected{% endif %}>{{ label }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-2">
                            <label class="form-label">&nbsp;</label>
                            <button type="submit" class="btn btn-primary d-block">Filter</button>
                        </div>
                        <div class="col-md-2">
                            <label class="form-label">&nbsp;</label>
                            <button type="button" class="btn btn-outline-secondary d-block" onclick="toggleBulkMode()">
                                <i class="bi bi-check-square"></i> Bulk Select
                            </button>
                        </div>
                    </form>
                </div>
            </div>
            
            <!-- Bulk Actions -->
            <div id="bulk-actions" class="bulk-actions">
                <div class="d-flex align-items-center gap-3">
                    <span id="selected-count">0 items selected</span>
                    <button class="btn btn-success btn-sm" onclick="bulkAction('approve')">
                        <i class="bi bi-check-lg"></i> Approve
                    </button>
                    <button class="btn btn-danger btn-sm" onclick="bulkAction('reject')">
                        <i class="bi bi-x-lg"></i> Reject
                    </button>
                    <button class="btn btn-warning btn-sm" onclick="bulkAction('escalate')">
                        <i class="bi bi-arrow-up"></i> Escalate
                    </button>
                    <button class="btn btn-info btn-sm" onclick="bulkAction('assign_to_me')">
                        <i class="bi bi-person-check"></i> Assign to Me
                    </button>
                    <button class="btn btn-outline-secondary btn-sm" onclick="clearSelection()">Clear</button>
                </div>
            </div>
            
            <!-- Review Queue Items -->
            <div class="review-queue">
                {% for item in page_obj %}
                <div class="review-item priority-{{ item.priority }}" data-item-id="{{ item.id }}">
                    <div class="row">
                        <div class="col-md-1 text-center">
                            <input type="checkbox" class="bulk-select-checkbox" style="display: none;">
                            <span class="badge priority-badge 
                                {% if item.priority == 1 %}bg-danger
                                {% elif item.priority == 2 %}bg-warning
                                {% elif item.priority == 3 %}bg-info
                                {% else %}bg-secondary{% endif %}">
                                P{{ item.priority }}
                            </span>
                        </div>
                        <div class="col-md-9">
                            <div class="d-flex justify-content-between align-items-start mb-2">
                                <h6 class="mb-1">
                                    <span class="badge bg-primary">{{ item.get_review_type_display }}</span>
                                    {% if item.post %}
                                        Post #{{ item.post.id }} in "{{ item.post.topic.subject|truncatechars:50 }}"
                                    {% elif item.topic %}
                                        Topic "{{ item.topic.subject|truncatechars:50 }}"
                                    {% elif item.reported_user %}
                                        User {{ item.reported_user.username }}
                                    {% endif %}
                                </h6>
                                <div class="text-muted small">
                                    Score: {{ item.score|floatformat:0 }} | 
                                    Age: {{ item.age_in_hours|floatformat:1 }}h
                                </div>
                            </div>
                            
                            <p class="mb-2"><strong>Reason:</strong> {{ item.reason|truncatechars:100 }}</p>
                            
                            {% if item.post %}
                            <div class="content-preview">
                                "{{ item.post.content|striptags|truncatechars:150 }}"
                            </div>
                            {% endif %}
                            
                            <div class="mt-2">
                                <small class="text-muted">
                                    Reported by {{ item.reporter.username|default:"System" }} on {{ item.created_at|date:"M j, Y H:i" }}
                                    {% if item.assigned_moderator %}
                                        | Assigned to {{ item.assigned_moderator.username }}
                                    {% endif %}
                                </small>
                            </div>
                        </div>
                        <div class="col-md-2 text-end">
                            <div class="btn-group-vertical">
                                <a href="{% url 'forum_integration:review_detail' item.id %}" class="btn btn-outline-primary btn-sm">
                                    <i class="bi bi-eye"></i> Review
                                </a>
                                {% if item.status == 'pending' %}
                                <button class="btn btn-success btn-sm" onclick="quickAction({{ item.id }}, 'approve')">
                                    <i class="bi bi-check"></i> Approve
                                </button>
                                <button class="btn btn-danger btn-sm" onclick="quickAction({{ item.id }}, 'reject')">
                                    <i class="bi bi-x"></i> Reject
                                </button>
                                {% if not item.assigned_moderator %}
                                <button class="btn btn-info btn-sm" onclick="quickAction({{ item.id }}, 'assign_to_me')">
                                    <i class="bi bi-person-plus"></i> Assign
                                </button>
                                {% endif %}
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
                {% empty %}
                <div class="text-center p-5">
                    <i class="bi bi-inbox" style="font-size: 3rem; color: var(--bs-secondary);"></i>
                    <h4 class="mt-3">No items to review</h4>
                    <p class="text-muted">The review queue is empty for the current filters.</p>
                </div>
                {% endfor %}
            </div>
            
            <!-- Pagination -->
            {% if page_obj.has_other_pages %}
            <nav aria-label="Review queue pagination">
                <ul class="pagination justify-content-center">
                    {% if page_obj.has_previous %}
                        <li class="page-item">
                            <a class="page-link" href="?page={{ page_obj.previous_page_number }}&status={{ status_filter }}&type={{ type_filter }}&assigned={{ assigned_filter }}&priority={{ priority_filter }}">Previous</a>
                        </li>
                    {% endif %}
                    
                    {% for num in page_obj.paginator.page_range %}
                        {% if page_obj.number == num %}
                            <li class="page-item active">
                                <span class="page-link">{{ num }}</span>
                            </li>
                        {% elif num > page_obj.number|add:'-3' and num < page_obj.number|add:'3' %}
                            <li class="page-item">
                                <a class="page-link" href="?page={{ num }}&status={{ status_filter }}&type={{ type_filter }}&assigned={{ assigned_filter }}&priority={{ priority_filter }}">{{ num }}</a>
                            </li>
                        {% endif %}
                    {% endfor %}
                    
                    {% if page_obj.has_next %}
                        <li class="page-item">
                            <a class="page-link" href="?page={{ page_obj.next_page_number }}&status={{ status_filter }}&type={{ type_filter }}&assigned={{ assigned_filter }}&priority={{ priority_filter }}">Next</a>
                        </li>
                    {% endif %}
                </ul>
            </nav>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let bulkModeActive = false;
let selectedItems = new Set();

function toggleBulkMode() {
    bulkModeActive = !bulkModeActive;
    const checkboxes = document.querySelectorAll('.bulk-select-checkbox');
    const bulkActions = document.getElementById('bulk-actions');
    
    if (bulkModeActive) {
        checkboxes.forEach(cb => cb.style.display = 'block');
        bulkActions.classList.add('show');
    } else {
        checkboxes.forEach(cb => {
            cb.style.display = 'none';
            cb.checked = false;
        });
        bulkActions.classList.remove('show');
        selectedItems.clear();
        updateSelectedCount();
    }
}

function updateSelectedCount() {
    document.getElementById('selected-count').textContent = `${selectedItems.size} items selected`;
}

// Handle checkbox changes
document.addEventListener('change', function(e) {
    if (e.target.classList.contains('bulk-select-checkbox')) {
        const itemId = e.target.closest('.review-item').dataset.itemId;
        if (e.target.checked) {
            selectedItems.add(itemId);
        } else {
            selectedItems.delete(itemId);
        }
        updateSelectedCount();
    }
});

function clearSelection() {
    selectedItems.clear();
    document.querySelectorAll('.bulk-select-checkbox').forEach(cb => cb.checked = false);
    updateSelectedCount();
}

function quickAction(itemId, action) {
    const reason = prompt(`Please provide a reason for ${action}ing this item:`);
    if (reason === null) return; // User cancelled
    
    fetch(`/forum/moderate/${itemId}/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value || getCookie('csrftoken')
        },
        body: `action=${action}&reason=${encodeURIComponent(reason)}`
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showMessage(data.message, 'success');
            location.reload(); // Refresh to show updated status
        } else {
            showMessage(data.error || 'An error occurred', 'error');
        }
    })
    .catch(error => {
        showMessage('Network error occurred', 'error');
        console.error('Error:', error);
    });
}

function bulkAction(action) {
    if (selectedItems.size === 0) {
        showMessage('Please select items first', 'warning');
        return;
    }
    
    const reason = prompt(`Please provide a reason for ${action}ing ${selectedItems.size} items:`);
    if (reason === null) return;
    
    fetch('/forum/moderate/bulk/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify({
            item_ids: Array.from(selectedItems),
            action: action,
            reason: reason
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showMessage(data.message, 'success');
            location.reload();
        } else {
            showMessage(data.error || 'An error occurred', 'error');
        }
    })
    .catch(error => {
        showMessage('Network error occurred', 'error');
        console.error('Error:', error);
    });
}

function showMessage(message, type) {
    // Create a temporary alert
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type === 'error' ? 'danger' : type} alert-dismissible fade show`;
    alertDiv.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    // Insert at top of content
    const container = document.querySelector('.container-fluid');
    container.insertBefore(alertDiv, container.firstChild);
    
    // Auto-dismiss after 5 seconds
    setTimeout(() => {
        if (alertDiv.parentNode) {
            alertDiv.remove();
        }
    }, 5000);
}

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
</script>
{% endblock %}